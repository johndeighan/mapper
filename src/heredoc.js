// Generated by CoffeeScript 2.6.1
// heredoc.coffee
var DEBUG, lAllHereDocNames, lAllHereDocs, qesc;

import {
  assert,
  isString,
  isEmpty,
  nonEmpty,
  undef,
  pass,
  croak,
  escapeStr,
  CWS
} from '@jdeighan/coffee-utils';

import {
  firstLine,
  remainingLines,
  joinBlocks
} from '@jdeighan/coffee-utils/block';

import {
  indented
} from '@jdeighan/coffee-utils/indent';

import {
  isTAML,
  taml
} from '@jdeighan/string-input/taml';

lAllHereDocs = [];

lAllHereDocNames = [];

DEBUG = false;

// ---------------------------------------------------------------------------
export var doDebug = function(flag = true) {
  DEBUG = flag;
};

// ---------------------------------------------------------------------------
export var lineToParts = function(line) {
  var lParts, pos, start;
  // --- Odd number of parts
  //     Each even index part is '<<<'
  lParts = []; // joined at the end
  pos = 0;
  while ((start = line.indexOf('<<<', pos)) !== -1) {
    if (start > pos) {
      lParts.push(line.substring(pos, start));
    }
    lParts.push('<<<');
    pos = start + 3;
  }
  if (line.length > pos) {
    lParts.push(line.substring(pos));
  }
  return lParts;
};

// ---------------------------------------------------------------------------
export var mapHereDoc = function(block) {
  var heredoc, i, j, len, result;
  for (i = j = 0, len = lAllHereDocs.length; j < len; i = ++j) {
    heredoc = lAllHereDocs[i];
    if (heredoc.isMyHereDoc(block)) {
      if (DEBUG) {
        console.log("--------------------------------------");
        console.log(`HEREDOC type '${lAllHereDocNames[i]}'`);
        console.log("--------------------------------------");
        console.log(block);
        console.log("--------------------------------------");
      }
      result = heredoc.map(block);
      assert(isString(result), "mapHereDoc(): result not a string");
      return result;
    }
  }
  return croak("No valid heredoc type found");
};

// ---------------------------------------------------------------------------
export var addHereDocType = function(obj, name = 'Unknown') {
  lAllHereDocs.unshift(obj);
  lAllHereDocNames.unshift(name);
};

// ---------------------------------------------------------------------------
// ---------------------------------------------------------------------------
export var BaseHereDoc = class BaseHereDoc {
  isMyHereDoc(block) {
    return true;
  }

  // --- If the returned string will represent a string, then
  //     you can get away with just returning the represented string
  //     here, which will be surrounded with quote marks and
  //     have internal special characters escaped
  mapToString(block) {
    return block;
  }

  // --- map() MUST return a string
  //     that string will replace '<<<' in your code
  map(block) {
    return '"' + qesc(this.mapToString(block)) + '"';
  }

};

// ---------------------------------------------------------------------------
export var BlockHereDoc = class BlockHereDoc extends BaseHereDoc {
  isMyHereDoc(block) {
    return firstLine(block) === '===';
  }

  mapToString(block) {
    return remainingLines(block);
  }

};

// ---------------------------------------------------------------------------
export var OneLineHereDoc = class OneLineHereDoc extends BaseHereDoc {
  isMyHereDoc(block) {
    return block.indexOf('...') === 0;
  }

  mapToString(block) {
    // --- replace all runs of whitespace with single space char
    block = block.replace(/\s+/gs, ' ');
    return block.substring(3).trim();
  }

};

// ---------------------------------------------------------------------------
export var TAMLHereDoc = class TAMLHereDoc extends BaseHereDoc {
  isMyHereDoc(block) {
    return isTAML(block);
  }

  map(block) {
    return JSON.stringify(taml(block));
  }

};

// ---------------------------------------------------------------------------
export var isFunctionHeader = function(str) {
  return str.match(/^\(\s*([A-Za-z_][A-Za-z0-9_]*(?:,\s*[A-Za-z_][A-Za-z0-9_]*)*)?\)\s*->\s*(.*)$/); // optional parameters
};

export var FuncHereDoc = class FuncHereDoc extends BaseHereDoc {
  isMyHereDoc(block) {
    return isFunctionHeader(firstLine(block));
  }

  map(block, lMatches = undef) {
    var _, rest, strParms;
    if (!lMatches) {
      lMatches = this.isMyHereDoc(block);
    }
    [_, strParms, rest] = lMatches;
    if (!strParms) {
      strParms = '';
    }
    block = remainingLines(block);
    if (isEmpty(block)) {
      if (isEmpty(rest)) {
        return '';
      } else {
        return `(${strParms}) -> ${rest.trim()}`;
      }
    } else {
      if (isEmpty(rest)) {
        return `(${strParms}) ->\n${block}`;
      } else {
        block = `${indented(rest, 1)}\n${block}`;
        return `(${strParms}) ->\n${block}`;
      }
    }
  }

};

// ---------------------------------------------------------------------------
// ---------------------------------------------------------------------------
qesc = function(block) {
  var hEsc;
  hEsc = {
    "\n": "\\n",
    "\r": "",
    "\t": "\\t",
    "\"": "\\\""
  };
  return escapeStr(block, hEsc);
};

// ---------------------------------------------------------------------------

// --- last one is checked first
addHereDocType(new BaseHereDoc(), 'default block');

addHereDocType(new FuncHereDoc(), 'function'); //  (args) ->

addHereDocType(new OneLineHereDoc(), 'one line'); //  ...

addHereDocType(new TAMLHereDoc(), 'taml'); //  ---

addHereDocType(new BlockHereDoc(), 'explicit block'); //  ===
